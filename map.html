<!DOCTYPE html>
<html>
  <head>
    <title>On A Boat App</title>
    <script src="https://api.tiles.mapbox.com/mapbox.js/v2.0.0/mapbox.js"></script>
    <link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox.js/v2.0.0/mapbox.css">
    <link rel="stylesheet" href="/css/map.css">
    <link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.css">
    <script src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-geodesy/v0.1.0/leaflet-geodesy.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
  </head>

  <body>
    <div id="map"></div>
    <script>
      L.mapbox.accessToken = 'pk.eyJ1IjoibHlvbndqIiwiYSI6IndwUXlLUjQifQ.DIiytYUASOcXjKdpXW8S-Q';
      var map = L.mapbox.map('map', 'lyonwj.j5m52ga3').setView([47.9017, -114.1042], 10);

      var featureGroup = L.featureGroup().addTo(map);
      var dataLayer = L.mapbox.featureLayer().addTo(map);
      var current_poly;
      var url = "http://192.241.222.136:7474/scdemo/scdemo/intersects"

      function dataToMarkers(data) {
          data = JSON.parse(data)       
          var geojson = { type: 'FeatureCollection', features: [] };
          
          for (var i = 0; i < data.length; i++) {
          
          if (data[i].lon === null || data[i].lat === null) continue;
          geojson.features.push({
            type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: [ data[i].lon, data[i].lat]
              },
            properties: {
          'marker-size': "large",
          'marker-color': "#c091e6",
          'title': data[i].name
          }
          });
      }
        dataLayer.setGeoJSON([]);
        dataLayer.setGeoJSON(geojson);
        }
        
      $("#category").change(function() {
        if (current_poly){
        
          data = {polygon: current_poly, category: $("#category").val()}
          $.ajax({
            url: url,
            data: data,
            success: dataToMarkers
            //dataType: dataType
          });
          }
        });
        
      var drawControl = new L.Control.Draw({
        edit: {
          featureGroup: featureGroup
        },
        draw: {
          polygon: true,
          polyline: false,
          rectangle: false,
          circle: false,
          marker: false
        }
      }).addTo(map);

      map.on('draw:created', showPolygonMarkers);
      map.on('draw:edited', showPolygonMarkersEdited);
      //map.on('draw:deleted', )

      function showPolygonMarkersEdited(e) {
        e.layers.eachLayer(function(layer) {
          showPolygonMarkers({ layer: layer });
        });
      }
      function showPolygonMarkers(e) {
        console.log(e);
        console.log($("#category").val());
        featureGroup.clearLayers();
        featureGroup.addLayer(e.layer);
        
        coords = e.layer['_latlngs']
        first = coords[0]['lat'] + " " + coords[0]['lng']+", "
        
        wkt = "POLYGON (("
        coords.forEach(getCoords)
        wkt = wkt + first.substring(0, first.length-2) + "))"
        console.log(wkt)
        
        
        current_poly = wkt
        data = {polygon: wkt, category: $("#category").val()}
        success = function(data){
          console.log(data)
        }
        
        
        
        
        $.ajax({
          url: url,
          data: data,
          success: dataToMarkers
          //dataType: dataType
        });
        
        
        
        
      }

      function getCoords(e) {
        group = e['lat'] + " " + e['lng']+", "
        console.log(group)
        wkt = wkt + group
      }


  </script>
  </body>
</html>